name: Build DEB (rootless)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          brew install ldid dpkg make

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      # âœ… FIX: make postinst executable so dpkg-deb doesn't fail
      - name: Fix postinst permissions
        run: |
          if [ -f "layout/DEBIAN/postinst" ]; then
            chmod 755 layout/DEBIAN/postinst
            ls -la layout/DEBIAN/postinst
          elif [ -f "DEBIAN/postinst" ]; then
            chmod 755 DEBIAN/postinst
            ls -la DEBIAN/postinst
          else
            echo "No postinst found, skipping."
          fi

      - name: Build rootless package
        run: |
          export THEOS=$THEOS
          make clean package THEOS_PACKAGE_SCHEME=rootless

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb
          path: packages/*.deb
